<%=
    # This code finds the `boot.cfg` file in the repository, parses it, and
    # makes a set of modifications intended to make it net-boot from Razor.
    #
    # I chose this path because the boot.cfg file varies between releases of
    # ESXi (such as 5.0 to 5.5), and could quite legitimately vary between
    # smaller jumps than that -- after all, it is inside their boot loader,
    # and they can change the construction of the installer CD without
    # breaking anything...
    #
    # The alternative was to copy in the boot.cfg, modify it the way this code
    # will do on the fly, and then use that.  That is actually the exact
    # process documented for setting up ESXi PXE boot -- statically make this
    # change -- too.
    #
    # Given the changes are purely mechanical and well understood, this will
    # do for the majority of cases without the risk / cost that a slight
    # variant in the CD breaks everything, I think. --daniel 2013-10-14
    (File.read(repo_file('/boot.cfg')) rescue '').split("\n").map do |line|
      case line
        when /^kernel=/
          'kernel=' + repo_url(line.sub('kernel=', ''))
        when /^modules=/
          line.gsub('/', repo_url('/'))
        when /^kernelopt=/
          #"kernelopt=ks=#{file_url('ks.cfg')}"
          if File.exists?("/opt/razor-server/tasks/vmware_esxi.task/ks_" + node.facts["serialnumber"] + ".cfg.erb")
            ks_file = file_url("ks_" + node.facts["serialnumber"] + ".cfg")
          else
            ks_file = file_url("ks.cfg")
          end

          ret = "kernelopt=ks=%s" % ks_file

          options = node.policy.node_metadata["installer_options"]
          if options && options["network_configuration"]
            require "json"
            require "asm/network_configuration"

            network_config = ASM::NetworkConfiguration.new(JSON.parse(options["network_configuration"]))
            partition = network_config.get_partitions("PXE").first
            if partition
              network = partition.networkObjects.find { |p| p["type"] == "PXE" }
              static = network.static && network.staticNetworkConfiguration
              if static
                # Add static IP address info
                #
                # Example from http://www.virtuallyghetto.com/2011/05/semi-interactive-automated-esxi.html
                # "kernelopt=ks=ks.cfg ip=172.25.3.105 netmask=255.255.0.0 gateway=172.25.0.1 nameserver=172.20.0.8"
                #
                # TODO: needs to be targeted to a specific NIC e.g. via mac address
                ret += " ip=%s netmask=%s gateway=%s" % [static.ipAddress, static.subnet, static.gateway]
              end
            end
          end
          ret
        else
          line
      end
    end.join("\n")
%>
